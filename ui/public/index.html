<script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
<script src="https://rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>

<link rel="stylesheet" type="text/css" href="./style.css">
<body style='margin : 0px; overflow: hidden;'>
<div id="app"></div>
<script src="./bundle.js"></script>

<script>
    AFRAME.registerComponent('entity-color', {
        schema: {default: 'skyblue'},
        init: function () {
            this.el.addEventListener('model-loaded', this.update.bind(this));
        },
        update: function () {
            let mesh = this.el.getObject3D('mesh');
            let data = this.data;
            if (!mesh) {
                return;
            }
            mesh.traverse(function (node) {
                if (node.isMesh) {
                    node.material.color.set(data);
                }
            });
        }
    });

    AFRAME.registerComponent('click-handler', {
        schema: {default: 'not assigned'},
        init: function () {
            const id = this.data;
            const animatedMarker = document.querySelector(`#marker_${id}`);
            const aEntity = document.querySelector(`#quest_${id}`);

            animatedMarker.addEventListener('click', function (ev, target) {
                const intersectedElement = ev && ev.detail && ev.detail.intersectedEl;
                if (aEntity && intersectedElement === aEntity) {
                    console.log(id);
                    window.store.dispatch(window.actions.fetchQuest(id))
                }
            });
        }
    });
</script>

<a-scene embedded
         arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3'>

    <a-assets>
        <a-asset-item id="znak-model" src="./model/znak.gltf"></a-asset-item>
    </a-assets>

    <a-marker id="marker_1"
              emitevents="true"
              cursor="fuse: false; rayOrigin: mouse"
              type='pattern'
              url='./markers/1-pattern-marker.patt'
              click-handler="1">
        <a-entity id="quest_1"
                  gltf-model="#znak-model"
                  scale="2 2 2"
                  entity-color>
        </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
</a-scene>

</body>
